/*! webrtc_broadcast_app 03-01-2016 */!function($){"use strict";var my_local_stream,app=angular.module("myWebRTC",[],function($locationProvider){$locationProvider.html5Mode(!0)}),client=new PeerManager,mediaConfig={audio:!0,video:{mandatory:{minWidth:1280,minHeight:720,maxWidth:1280,maxHeight:720,frameRate:{min:35,ideal:50,max:60}}}};app.factory("camera",["$rootScope","$window",function($rootScope,$window){var camera={};return camera.preview=$window.document.getElementById("localVideo"),camera.isOn=!1,camera.start=function(){return requestUserMedia(mediaConfig).then(function(stream){my_local_stream=stream,attachMediaStream(camera.preview,stream),client.setLocalStream(stream),camera.stream=stream,camera.isOn=!0,$rootScope.$broadcast("cameraIsOn",!0),console.log("OnSuccess...")},function(arg_error){console.log("OnError...")})["catch"](Error("Failed to get access to local media."))},camera.stop=function(){return new Promise(function(resolve,reject){try{camera.stream.stop(),camera.preview.src="",resolve()}catch(error){reject(error)}}).then(function(result){camera.isOn=!1,$rootScope.$broadcast("cameraIsOn",!1)})},camera}]),app.controller("IndexController",["$window","$location",function($window,$location){}]),app.controller("RemoteStreamsController",["camera","$location","$http","$window",function(camera,$location,$http,$window){function getStreamById(id){for(var i=0;i<rtc.remoteStreams.length;i++)if(rtc.remoteStreams[i].id===id)return rtc.remoteStreams[i]}var rtc=this;rtc.remoteStreams=[],rtc.loadData=function(){$http.get("/streams").success(function(data){for(var streams=data.filter(function(stream){return stream.id!=client.getId()}),i=0;i<streams.length;i++){var stream=getStreamById(streams[i].id);streams[i].isPlaying=stream?stream.isPlaying:!1}rtc.remoteStreams=streams,console.log("update stream list...")})},client.add_external_mechanism("load_data",rtc.loadData),rtc.view=function(stream){client.peerInit(stream.id),stream.isPlaying=!stream.isPlaying},rtc.call=function(stream){stream.id||(stream={id:stream,isPlaying:!1},rtc.remoteStreams.push(stream)),camera.isOn?(client.toggleLocalStream(stream.id),stream.isPlaying,client.peerInit(stream.id),stream.isPlaying=!stream.isPlaying):camera.start().then(function(result){client.toggleLocalStream(stream.id),stream.isPlaying,client.peerInit(stream.id),stream.isPlaying=!stream.isPlaying})["catch"](function(err){console.log(err)})},rtc.loadData()}]),app.controller("LocalStreamController",["camera","$scope","$window",function(camera,$scope,$window){var localStream=this;localStream.name="Station",localStream.link="",localStream.cameraIsOn=!1,localStream.isFirefox=!!navigator.mozGetUserMedia,$scope.$on("cameraIsOn",function(event,data){$scope.$apply(function(){localStream.cameraIsOn=data})}),localStream.init=function(arg_user_type){localStream.user_type=arg_user_type},localStream.is_start_recording_btn_disabled=!1,localStream.is_stop_recording_btn_disabled=!0,localStream.toggleCam=function(){return""===localStream.name.trim()?(alert("Station name is empty; please provide a station name"),!1):void(localStream.cameraIsOn?camera.stop().then(function(result){localStream.is_start_recording_btn_disabled&&localStream.stop_recording(),client.send("leave"),client.setLocalStream(null)})["catch"](function(err){console.log(err)}):(console.log("start camera..."),camera.start().then(function(result){localStream.link=$window.location.host+"/"+client.getId(),client.send("readyToStream",{name:localStream.name,user_type:localStream.user_type})})["catch"](function(err){console.log(err)})))},localStream.start_recording=function(){my_local_stream&&(localStream.start_timestamp=(new Date).getTime(),localStream.record_rtc=RecordRTC(my_local_stream,{bufferSize:32768,type:"video"}),localStream.record_rtc.startRecording(),localStream.is_start_recording_btn_disabled=!0,localStream.is_stop_recording_btn_disabled=!1)},localStream.stop_recording=function(){localStream.record_rtc.stopRecording(function(){localStream.stop_timestamp=(new Date).getTime();var file_name=localStream.name+"-"+localStream.start_timestamp+"_"+localStream.stop_timestamp;localStream.is_start_recording_btn_disabled=!1,localStream.is_stop_recording_btn_disabled=!0,localStream.record_rtc.save(file_name)})}}])}(jQuery);