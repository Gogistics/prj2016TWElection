/*! webrtc_broadcast_app 03-01-2016 */var PeerManager=function(){function addPeer(remoteId){var peer=new Peer(config.peerConnectionConfig,config.peerConnectionConstraints,remoteId);return peer.pc.onicecandidate=function(event){event.candidate&&send("candidate",remoteId,{label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate})},peer.pc.onaddstream=function(event){attachMediaStream(peer.remoteVideoEl,event.stream),remoteVideosContainer.appendChild(peer.remoteVideoDiv)},peer.pc.onremovestream=function(event){try{remoteVideosContainer.hasChildNodes()&&remoteVideosContainer.contains(peer.remoteVideoDiv)&&remoteVideosContainer.removeChild(peer.remoteVideoDiv)}catch(err){console.log(err)}},peer.pc.oniceconnectionstatechange=function(event){switch((event.srcElement||event.target).iceConnectionState){case"disconnected":try{remoteVideosContainer.hasChildNodes()&&remoteVideosContainer.contains(peer.remoteVideoDiv)&&remoteVideosContainer.removeChild(peer.remoteVideoDiv)}catch(err){console.log(err)}}},peer.pc.removeStream=function(stream){peer.pc.getSenders().forEach(function(sender){console.log(sender);try{peer.pc.removeTrack(sender),remoteVideosContainer.hasChildNodes()&&remoteVideosContainer.contains(peer.remoteVideoDiv)&&remoteVideosContainer.removeChild(peer.remoteVideoDiv)}catch(err){console.log(err)}})},peerDatabase[remoteId]=peer,peer}function answer(remoteId){var pc=peerDatabase[remoteId].pc;pc.createAnswer(function(sessionDescription){pc.setLocalDescription(sessionDescription),send("answer",remoteId,sessionDescription)},error)}function offer(remoteId){var pc=peerDatabase[remoteId].pc;pc.createOffer(function(sessionDescription){pc.setLocalDescription(sessionDescription),send("offer",remoteId,sessionDescription)},error)}function handleMessage(message){var type=message.type,from=message.from,pc=(peerDatabase[from]||addPeer(from)).pc;switch(console.log("received "+type+" from "+from),type){case"init":toggleLocalStream(pc),offer(from);break;case"offer":pc.setRemoteDescription(new RTCSessionDescription(message.payload),function(){},error),answer(from);break;case"answer":pc.setRemoteDescription(new RTCSessionDescription(message.payload),function(){},error);break;case"candidate":pc.remoteDescription&&pc.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:message.payload.label,sdpMid:message.payload.id,candidate:message.payload.candidate}),function(){},error)}}function send(type,to,payload){console.log("sending "+type+" to "+to),socket.emit("message",{to:to,type:type,payload:payload})}function toggleLocalStream(pc){localStream&&(pc.getLocalStreams().length?pc.removeStream(localStream):pc.addStream(localStream))}function error(err){console.log(err)}var local_id,localStream,config={peerConnectionConfig:{iceServers:[{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun.anyfirewall.com:3478"},{urls:"stun:stun.l.google.com:19302"},{urls:"turn:turn.bistri.com:80",credential:"homeo",username:"homeo"},{urls:"turn:turn.anyfirewall.com:443?transport=tcp",credential:"webrtc",username:"webrtc"},{urls:"stun:stun.services.mozilla.com"}]},peerConnectionConstraints:{optional:[{DtlsSrtpKeyAgreement:!0}]}},peerDatabase={},socket=(document.getElementById("remoteVideosContainer"),io()),external_mechanism={};return socket.on("message",handleMessage),socket.on("id",function(id){local_id=id}),socket.on("stream_notification",function(res){if(console.log(res),external_mechanism.hasOwnProperty("load_data")){if("stream_off"===res.notification_key){var remote_id=res.client_id_from,peer=peerDatabase[remote_id];try{remoteVideosContainer.hasChildNodes()&&remoteVideosContainer.contains(peer.remoteVideoDiv)&&remoteVideosContainer.removeChild(peer.remoteVideoDiv)}catch(err){console.log(err)}}external_mechanism.load_data(),console.log("stream_notification: update stream list...")}}),{getId:function(){return local_id},setLocalStream:function(stream){if(!stream)for(id in peerDatabase)pc=peerDatabase[id].pc,pc.getLocalStreams().length&&(pc.removeStream(localStream),offer(id));localStream=stream},toggleLocalStream:function(remoteId){peer=peerDatabase[remoteId]||addPeer(remoteId),toggleLocalStream(peer.pc)},peerInit:function(remoteId){return peer=peerDatabase[remoteId]||addPeer(remoteId),send("init",remoteId,null),peer},peerRenegociate:function(remoteId){offer(remoteId)},send:function(type,payload){socket.emit(type,payload)},add_external_mechanism:function(arg_mechanism_name,arg_mechanism){external_mechanism[arg_mechanism_name]=arg_mechanism},start_recording:function(arg_stream_id){},stop_recording:function(arg_stream_id){}}},Peer=function(pcConfig,pcConstraints,arg_remote_id){this.pc=new RTCPeerConnection(pcConfig,pcConstraints),this.remoteVideoEl=document.createElement("video"),this.remoteVideoEl.controls=!0,this.remoteVideoEl.autoplay=!0,this.remoteVideoEl.muted=!0,this.remoteVideoEl.id=arg_remote_id,this.start_recording_btn=document.createElement("input"),this.stop_recording_btn=document.createElement("input"),this.start_recording_btn.setAttribute("type","button"),this.stop_recording_btn.setAttribute("type","button"),this.start_recording_btn.className="col-sm-6 col-xs-12 btn btn-default",this.stop_recording_btn.className="col-sm-6 col-xs-12 btn btn-default",this.start_recording_btn.setAttribute("value","Start Recording"),this.stop_recording_btn.setAttribute("value","Stop Recording"),this.remoteVideoDiv=document.createElement("div"),this.remoteVideoDiv.className="remoteVideosDiv",this.remoteVideoDiv.id=arg_remote_id,this.remoteVideoDiv.appendChild(document.createElement("hr")),this.remoteVideoDiv.appendChild(this.remoteVideoEl),this.remoteVideoDiv.appendChild(document.createElement("br")),this.remoteVideoDiv.appendChild(this.start_recording_btn),this.remoteVideoDiv.appendChild(this.stop_recording_btn)};