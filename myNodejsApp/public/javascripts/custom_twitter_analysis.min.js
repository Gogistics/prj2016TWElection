/*! docker-debian-hello-world 11-03-2016 */!function($){"use strict";window.twitter_analysis_handler=window.twitter_analysis_handler||{get_analysis_collection:function(){var _this=this;$.ajax({data:{token:"ZRIcsERQBbPOgerGEhRthrt"},type:"POST",url:"/services/get_twitter_tweets_analysis_collection_by_lang_type",success:function(res){"successful"===res.request_status?(_this.append_categorized_data(res.collecion,res.count_of_total_tweets),_this.display_tweets_chart(res.collecion)):console.log("fail...")}})},append_categorized_data:function(arg_collection,arg_count_of_total_tweets){var min_timestamp=void 0,max_timestamp=void 0;for(var ith_key in arg_collection){var timestamp_set=arg_collection[ith_key].timestamp_set,total_count=0;for(var jth_key in timestamp_set)min_timestamp=void 0===min_timestamp?jth_key:Math.min(min_timestamp,jth_key),max_timestamp=void 0===max_timestamp?jth_key:Math.max(max_timestamp,jth_key),total_count+=timestamp_set[jth_key];var content='<li class="list-group-item">'+ith_key+'<span class="label label-warning label-pill pull-right">'+total_count+" ("+(total_count/arg_count_of_total_tweets*100).toFixed(2)+"%)</span></li>";$("ul#categorized_collection").append(content)}var min_date=new Date(min_timestamp),max_date=new Date(max_timestamp);$("p#categorized_collection_period").prepend("From&nbsp;"+(min_date.getMonth()+1)+"-"+min_date.getDate()+"-"+min_date.getFullYear()+" To&nbsp;"+(max_date.getMonth()+1)+"-"+max_date.getDate()+"-"+max_date.getFullYear())},display_tweets_chart:function(arg_collection){var rearranged_collection={};for(var ith_key in arg_collection)for(var jth_key in arg_collection[ith_key].timestamp_set)rearranged_collection.hasOwnProperty(jth_key)?rearranged_collection[jth_key]+=arg_collection[ith_key].timestamp_set[jth_key]:rearranged_collection[jth_key]=arg_collection[ith_key].timestamp_set[jth_key];var margin={top:10,right:10,bottom:30,left:60},width=460-margin.left-margin.right,height=250-margin.top-margin.bottom,x=d3.time.scale().range([0,width]),y0=d3.scale.linear().range([height,0]),xAxis=d3.svg.axis().scale(x).orient("bottom").ticks(5),yAxisLeft=d3.svg.axis().scale(y0).orient("left").ticks(5,"s"),valueline=d3.svg.line().x(function(d){return x(d.date)}).y(function(d){return y0(d.value)}),svg=d3.select("div#tweets_chart").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),make_y_axis=function(){return d3.svg.axis().scale(y0).orient("left").ticks(5)};svg.append("svg:g").attr("class","grid").call(make_y_axis().tickSize(-width,0,0).tickFormat(""));var build_chart=function(arg_rearranged_collection){var new_collection_ary=[];for(var ith_key in arg_rearranged_collection)new_collection_ary.push({date:new Date(Number(ith_key)),value:arg_rearranged_collection[ith_key]});new_collection_ary.sort(function(a,b){return a.date-b.date}),x.domain(d3.extent(new_collection_ary,function(d){return d.date})),y0.domain([0,d3.max(new_collection_ary,function(d){return Math.max(d.value)})]),svg.append("path").attr("class","line_1").attr("d",valueline(new_collection_ary)),svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),svg.append("g").attr("class","y axis").style("fill","#c79825").call(yAxisLeft).append("text").attr("transform","rotate(-90)").attr("y",-50).attr("dy",".4em").style("text-anchor","end").style("font-size",12).text("Tweets");var bisectDate=d3.bisector(function(d){return d.date}).left,formatValue=d3.format(",.0f"),formatTweets=function(d){return formatValue(d)},div=d3.select("div#summary_tip").append("div").attr("class","tooltip").style("opacity",0),focus=svg.append("g").attr("class","focus").style("display","none");focus.append("circle").attr("r",3),focus.append("text").attr("x",9).attr("dy",".3em"),svg.append("rect").attr("class","overlay").attr("width",width).attr("height",height).on("mouseout",function(){div.transition().duration(300).style("opacity",0)}).on("mousemove",function(){var x0=x.invert(d3.mouse(this)[0]),i=bisectDate(new_collection_ary,x0,1),d0=new_collection_ary[i-1],d1=new_collection_ary[i];if(d0&&d1){var d=x0-d0.date>d1.date-x0?d1:d0;div.transition().duration(200).style("opacity",.9),div.html("<div><strong>Date:&nbsp;"+d.date.toLocaleDateString()+"</strong><br/><p><label>Tweets:&nbsp;</label>"+formatTweets(d.value)+"</p></div>").style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY-10+"px")}})};build_chart(rearranged_collection)},get_twitter_tweets:function(){var _this=this;$.ajax({data:{token:"IDQWpckbiKLZUotOgerGEhRAEBwxYA"},type:"POST",url:"/services/get_twitter_tweets",success:function(res){"successful"===res.request_status?_this.append_twitter_tweets(res.top_tweets_categories):console.log("fail...")}})},append_twitter_tweets:function(arg_tweets){var tweets_list=[];for(var ith_key in arg_tweets)tweets_list=tweets_list.concat(arg_tweets[ith_key].tweets);var top_five_tweets_list=$("div#top_tweets_with_highest_retweet_count");top_five_tweets_list.empty();for(var jth in tweets_list)tweets_list[jth].tweet.text=tweets_list[jth].tweet.text.replace(/(http[s]*:[^\s]+)/gi,function(arg_link){return'<a href="'+arg_link+'" target="_blank">'+arg_link+"</a>"}),top_five_tweets_list.append('<div class="col-sm-4 col-xs-12"><img src="'+tweets_list[jth].tweet.user.profile_image_url+'"><br/><a href="https://twitter.com/'+tweets_list[jth].tweet.user.screen_name+'" target="_blank" >@'+tweets_list[jth].tweet.user.screen_name+"</a><br><span>Retweet&nbsp;Counts:&nbsp;"+tweets_list[jth].tweet.retweet_count+"</span><br/><span>Created at:&nbsp;"+new Date(tweets_list[jth].tweet.created_at)+"</span><br/><p>"+tweets_list[jth].tweet.text+"</p></div>")},prepend_elem_to_ary:function(arg_val,arg_ary){var new_ary=arg_ary.slice(0);return new_ary.unshift(arg_val),new_ary},get_tweets_keywords:function(){var _this=this;$.ajax({data:{token:"IDQWpckbiKLZUotOgerGEhRAEBwxYA"},type:"POST",url:"/services/get_tweets_keywords",success:function(res){"successful"===res.request_status?_this.build_keywords_circle_packing(res.tweet_keywords.filtered_keywords):console.log("fail...")}})},build_keywords_circle_packing:function(arg_keywords){function zoom(d){focus=d;var transition=d3.transition().duration(d3.event.altKey?7500:750).tween("zoom",function(d){var i=d3.interpolateZoom(view,[focus.x,focus.y,2*focus.r+margin]);return function(t){zoomTo(i(t))}});transition.selectAll("text").filter(function(d){return d.parent===focus||"inline"===this.style.display}).style("fill-opacity",function(d){return d.parent===focus?1:0}).each("start",function(d){d.parent===focus&&(this.style.display="inline")}).each("end",function(d){d.parent!==focus&&(this.style.display="none")})}function zoomTo(v){var k=diameter/v[2];view=v,node.attr("transform",function(d){return"translate("+(d.x-v[0])*k+","+(d.y-v[1])*k+")"}),circle.attr("r",function(d){return d.r*k})}arg_keywords.sort(function(a,b){return b.count-a.count});var view,top_10=arg_keywords.slice(0,10),margin=5,diameter=250,color=d3.scale.linear().domain([-1,6]).range(["hsl(46, 96%, 64%, 95%)","hsl(46, 96%, 32%, 95%)"]).interpolate(d3.interpolateHcl),pack=d3.layout.pack().padding(2).size([diameter-margin,diameter-margin]).value(function(d){return d.count}),svg=d3.select("div#top_tweets_keywords").append("svg").attr("width",diameter).attr("height",diameter).append("g").attr("transform","translate("+diameter/2+","+diameter/2+")"),root={word:"Top-Tweets",children:top_10},focus=root,nodes=pack.nodes(root),circle=svg.selectAll("circle").data(nodes).enter().append("circle").attr("class",function(d){return d.parent?d.children?"node":"node node--leaf":"node node--root"}).style("fill",function(d){return d.children?color(d.depth):null}).on("click",function(d){focus!==d&&(zoom(d),d3.event.stopPropagation())}),node=(svg.selectAll("text").data(nodes).enter().append("text").attr("class","label").style("fill-opacity",function(d){return d.parent===root?1:0}).style("display",function(d){return d.parent===root?"inline":"none"}).text(function(d){return d.word}),svg.selectAll("circle,text"));d3.select("div#top_tweets_keywords").on("click",function(){zoom(root)}),zoomTo([root.x,root.y,2*root.r+margin]),d3.select(self.frameElement).style("height",diameter+"px")},get_tweet_geo_info:function(){var _this=this;$.ajax({data:{token:"IDQWpckbiKLZUotOgerGEhRAEBwxYA"},type:"POST",url:"/services/get_tweet_geo_info",success:function(res){"successful"===res.request_status?_this.build_tweets_distribution_map(res.tweets_geo_info):console.log("fail...")}})},build_tweets_distribution_map:function(arg_tweets_geo_info){var tweets_geo_location={},_leaflet_map_handler={map:void 0,tiles:void 0,my_icon:void 0,init_map:function(){"undefined"==typeof this.map&&(this.map=new L.Map("tweets_distribution_map",{center:[52.971157,7.784151],zoom:2}).addLayer(new L.TileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png")))},move_map:function(arg_percentage,arg_latlng){}},colors_map={0:"#ccfef8",10:"#b4fcf6",20:"#b4f6fc",30:"#86e8f1",40:"#5dd8e3",50:"#4ac7f5",60:"#4aa7f5",70:"#248ce4",80:"#1a70b8",90:"#085393",100:"#053964",defaultFill:"#EFEFEF"};_leaflet_map_handler.init_map();var width=760,height=550,tip_div=d3.select("div#summary_tip").append("div").attr("class","tooltip").style("opacity",0),svg=(d3.geo.path(),d3.select(_leaflet_map_handler.map.getPanes().overlayPane).append("svg").attr("width",width).attr("height",height)),g=svg.append("g").attr("class","leaflet-zoom-hide");d3.csv("/public/files/id_country.csv",function(err,csv_to_json_data){csv_to_json_data.forEach(function(elem,index){tweets_geo_location[elem.id]={name:elem.name}}),d3.json("/public/files/countries_geo.json",function(err,arg_country_code_data){function reset(){var bounds=path.bounds(collection),topLeft=bounds[0],bottomRight=bounds[1];svg.attr("width",bottomRight[0]-topLeft[0]).attr("height",bottomRight[1]-topLeft[1]).style("left",topLeft[0]+"px").style("top",topLeft[1]+"px"),g.attr("transform","translate("+-topLeft[0]+","+-topLeft[1]+")"),feature.attr("d",path)}function projectPoint(x,y){var point=_leaflet_map_handler.map.latLngToLayerPoint(new L.LatLng(y,x));this.stream.point(point.x,point.y)}var collection=arg_country_code_data,temp_collection={type:"FeatureCollection",features:[]},total_count=0,max_count=0;collection.features.forEach(function(elem,index){if(tweets_geo_location.hasOwnProperty(elem.id)&&arg_tweets_geo_info.tweets[elem.id]){var avg_lat=0,avg_lng=0;elem.geometry.coordinates[0].forEach(function(geo_info,index){avg_lat+=Number(geo_info[1]),avg_lng+=Number(geo_info[0])}),avg_lat=(avg_lat/elem.geometry.coordinates[0].length).toFixed(5),avg_lng=(avg_lng/elem.geometry.coordinates[0].length).toFixed(5),tweets_geo_location[elem.id].hasOwnProperty("lat_lng_ary")?tweets_geo_location[elem.id].lat_lng_ary.push({lat:avg_lat,lng:avg_lng}):(tweets_geo_location[elem.id].lat_lng_ary=[],tweets_geo_location[elem.id].lat_lng_ary.push({lat:avg_lat,lng:avg_lng}));var data_set=tweets_geo_location[elem.id];data_set.country_id=elem.id,data_set.count=arg_tweets_geo_info.tweets[elem.id].count,total_count+=arg_tweets_geo_info.tweets[elem.id].count,arg_tweets_geo_info.tweets[elem.id].count>max_count&&(max_count=arg_tweets_geo_info.tweets[elem.id].count),elem.tweets_geo_location=data_set,temp_collection.features.push(elem)}}),collection=temp_collection;var transform=d3.geo.transform({point:projectPoint}),path=d3.geo.path().projection(transform),feature=g.selectAll("path").data(collection.features).enter().append("path").attr("class","geo_path").style("fill",function(d){var color_key=10*Math.floor(d.tweets_geo_location.count/max_count*10);return colors_map[color_key.toString()]}).on("mouseover",function(d){tip_div.transition().duration(200).style("opacity",.95),tip_div.html("<div><strong>&nbsp;Country:&nbsp;"+d.tweets_geo_location.name+"</strong><br></div>").style("left",d3.event.pageX-10+"px").style("top",d3.event.pageY-10+"px")}).on("mouseout",function(d){tip_div.transition().duration(300).style("opacity",0)});_leaflet_map_handler.map.on("viewreset",reset),reset()})})}},window.twitter_analysis_handler.get_analysis_collection(),window.twitter_analysis_handler.get_twitter_tweets(),window.twitter_analysis_handler.get_tweets_keywords(),window.twitter_analysis_handler.get_tweet_geo_info()}(jQuery);